# 23.7.1项目开发日志

## 一、创建项目

在`github`上创建`WebsiteDevExamination`和`WebsiteDevInterface`仓库

使用`git clone git@github.com:Undefined6608/WebsiteDevInterface.git`和`git clone git@github.com:Undefined6608/WebsiteDevExamination.git`将其克隆到本地

## 二、初始化项目

使用`WebStorm`打开`WebsiteDevInterface`文件夹：

打开控制台运行以下命令，进行初始化项目：

```shell
npm init -y
```

创建项目所需文件，项目结构：

![](http://39.101.72.168:81/image/examination/log/Snipaste_2023-07-01_10-44-13.png)

## 三、导入/配置依赖

> 使用的依赖/框架：
>
> `express`：项目框架
>
> `cors`：跨域第三方依赖
>
> `typescript`，`ts-node`：引入ts
>
> `nodemon`：热启动依赖，
>
> `log4js`：日志依赖
>
> `morgan`：控制台输出请求调用情况

```shell
npm install express cors --save
npm install typescript ts-node nodemon --save-dev
npm install log4js
npm install morgan
```

编写`app.ts`：

```ts
// 引入express
const express = require('express');
// 引入cors
const cors = require('cors');
// 引入morgan
const morgan = require('morgan');
// 导入错误处理中间件
const errorHandler = require('./middleware/error-handler');

// 实例化express
const app = express();
// 定义监听端口
const port = process.env.PORT || 4000;

// 定义允许跨域请求的请求源地址列表
const allowedOrigins: string[] = [
    'http://192.168.126.1:3000',
    'http://localhost:3000'
];

// 添加中间件
// 挂载cors实现跨域
app.use(cors({
    origin: (origin: string, callback) => {
        // 检查请求的来源是否在允许的列表中
        if (!origin || allowedOrigins.indexOf(origin) !== -1) {
            callback(null, true);
        } else {
            callback(new Error('不允许的来源'));
        }
    },
    methods: ['GET', 'POST', 'PUT', 'DELETE'], // 允许的请求方法
    credentials: true // 允许携带凭证（如 Cookie）
}));
//挂载morgan进行监听请求并输出
app.use(morgan('dev'));
// 配置和挂载解析body请求体方法
app.use(express.json());
app.use(express.urlencoded({extended: false, limit: '20mb'}));
// 挂载统一处理服务器错误的中间件
app.use(errorHandler());

// 添加路由和处理程序
app.get('/', (req, res) => {
    res.send('Hello, world!');
});

// 启动应用,开启端口监听
app.listen(port, () => {
    console.log(`Server is running on port ${port}`);
});
```

编写`tsconfig.json`：

```json
{
    "compilerOptions": {
        "lib": ["ES6"],
        "module": "commonjs",
        "moduleResolution": "node",
        "outDir": "dist",
        "target": "es6",
        "sourceMap": true,
        "allowSyntheticDefaultImports": true
    },
    "include": [
        "app.ts"
    ]
}
```

在`config`中创建`config.default.ts`文件:

```ts
// 导入log4js
const log4js = require("log4js");
// 配置log4js
log4js.configure({ // 复写配置信息
    appenders: { // 配置存储日志格式
        file: { // 配置存储类型
            type: 'file',// 配置存储类型为文件类型
            filename: 'logs/app.log', // 配置日志存储位置
            maxLogSize: 10 * 1024 * 1024, // 配置日志最大为10 MB
            backups: 3, // 超出最大大小，将保存备份，备份最大3个
            compress: true, // 启用Gzip压缩备份文件
            pattern: '-yyyy-MM-dd.log' // 保存日志写入时间戳
        },
        console: { // 配置控制台输出
            type: 'console', // 输出类型
        },
    },
    categories: { // 定义不同日志分类
        default: {appenders: ['file', 'console'], level: 'info'},// 配置默认分类
    }
});
// 实例化log4js对象
export const logger = log4js.getLogger();
```

在`middleware`文件夹中创建`error-handler.ts`文件,用于处理服务器错误:

```ts
import {logger} from '../config/config.default';

module.exports = () => {
    return (err, req, res, next) => {
        logger.error(err);
        res.status(500).json({
            error: "信息错误！"
        })
    }
}
```

## 四、创建路由

在`router`文件夹中创建`index.ts`：

```ts
// 引入express
const express  = require('express');
// 创建router实例
const router = express.Router();

// 挂载子路由

// 抛出路由
export default router;
```

在`app.ts`中挂载路由，**注意：路由一般在`app.ts`的最下面，在端口监听上面**

```ts
// 添加路由和处理程序
app.use('/api', router);
```

### 创建子路由

在`router`文件夹中创建`homeRouter.ts`、`aboutRouter.ts`、`productRouter.ts`、`informationRouter.ts`,`contactRouter.ts`

将子路由挂载到主路由上，在`router/index.ts`中：

```ts
// 引入express
const express = require('express');
// 引入子路由
import homeRouter from "./homeRouter";
import aboutRouter from "./aboutRouter";
import productRouter from "./productRouter";
import informationRouter from "./informationRouter";
import contactRouter from "./contactRouter";
// 创建router实例
const router = express.Router();

// 挂载子路由
router.use('/home', homeRouter);
router.use('/about', aboutRouter);
router.use('/product', productRouter);
router.use('/information', informationRouter);
router.use('/contact', contactRouter);
// 抛出路由
export default router;
```

## 五、创建控制器

在`controller`文件夹中创建`homeController.ts`、`aboutController.ts`、`productController.ts`、`informatonController.ts`、`contactController.ts`、

## 六、开始编写后端项目

在`homeController.ts`中

在`homeRouter.ts`中：

```ts
// 引入express
import {getLogo} from "../controller/homeController";

const express = require('express');
// 创建router实例
const homeRouter = express.Router();

// 定义路由
homeRouter.get('/logo', getLogo);

// 抛出路由
export default homeRouter;
```











